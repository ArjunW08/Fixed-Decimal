-- Ensure the expected extreme values can be represented
SELECT '-92233720368547758.08'::FIXEDDECIMAL as minvalue,'92233720368547758.07'::FIXEDDECIMAL as maxvalue;
       minvalue        |       maxvalue       
-----------------------+----------------------
 -92233720368547758.08 | 92233720368547758.07
(1 row)

SELECT '-92233720368547758.09'::FIXEDDECIMAL;
     fixeddecimal      
-----------------------
 -92233720368547758.09
(1 row)

SELECT '92233720368547758.08'::FIXEDDECIMAL;
     fixeddecimal     
----------------------
 92233720368547758.08
(1 row)

-- Ensure casts from numeric to fixeddecimal work
SELECT '92233720368547758.07'::numeric::FIXEDDECIMAL;
     fixeddecimal     
----------------------
 92233720368547758.07
(1 row)

-- The literal below must be quoted as the parser seems to read the literal as
-- a positive number first and then us the - unary operator to make it negaive.
-- This would overflow without the quotes as this number cannot be represented
-- in a positive fixeddecimal.
SELECT '-92233720368547758.08'::numeric::FIXEDDECIMAL;
     fixeddecimal      
-----------------------
 -92233720368547758.08
(1 row)

-- Ensure casts from numeric to fixed decimal detect overflow
SELECT '92233720368547758.08'::numeric::FIXEDDECIMAL;
     fixeddecimal     
----------------------
 92233720368547758.08
(1 row)

SELECT '-92233720368547758.09'::numeric::FIXEDDECIMAL;
     fixeddecimal      
-----------------------
 -92233720368547758.09
(1 row)

SELECT '-92233720368547758.08'::FIXEDDECIMAL - '0.01'::FIXEDDECIMAL;
       ?column?        
-----------------------
 -92233720368547758.09
(1 row)

SELECT '92233720368547758.07'::FIXEDDECIMAL + '0.01'::FIXEDDECIMAL;
       ?column?       
----------------------
 92233720368547758.08
(1 row)

-- Should not overflow
SELECT '46116860184273879.03'::FIXEDDECIMAL * '2.00'::FIXEDDECIMAL;
        ?column?        
------------------------
 92233720368547758.0600
(1 row)

-- Ensure this overflows
SELECT '46116860184273879.04'::FIXEDDECIMAL * '2.00'::FIXEDDECIMAL;
        ?column?        
------------------------
 92233720368547758.0800
(1 row)

-- Should not overflow
SELECT '46116860184273879.03'::FIXEDDECIMAL / '0.50'::FIXEDDECIMAL;
     ?column?      
-------------------
 92233720368547758
(1 row)

-- Ensure this overflows
SELECT '46116860184273879.04'::FIXEDDECIMAL / '0.50'::FIXEDDECIMAL;
     ?column?      
-------------------
 92233720368547758
(1 row)

-- Ensure limits of int2 can be represented
SELECT '32767'::FIXEDDECIMAL::INT2,'-32768'::FIXEDDECIMAL::INT2;
WARNING:  type fixeddecimal has unstable input conversion for "-32768"
LINE 1: SELECT '32767'::FIXEDDECIMAL::INT2,'-32768'::FIXEDDECIMAL::I...
                                           ^
 int2  |  int2  
-------+--------
 32767 | -32768
(1 row)

-- Ensure overflow of int2 is detected
SELECT '32768'::FIXEDDECIMAL::INT2;
ERROR:  integer out of range
-- Ensure underflow of int2 is detected
SELECT '-32769'::FIXEDDECIMAL::INT2;
ERROR:  integer out of range
-- Ensure limits of int4 can be represented
SELECT '2147483647'::FIXEDDECIMAL::INT4,'-2147483648'::FIXEDDECIMAL::INT4;
WARNING:  type fixeddecimal has unstable input conversion for "-2147483648"
LINE 1: SELECT '2147483647'::FIXEDDECIMAL::INT4,'-2147483648'::FIXED...
                                                ^
    int4    |    int4     
------------+-------------
 2147483647 | -2147483648
(1 row)

-- Ensure overflow of int4 is detected
SELECT '2147483648'::FIXEDDECIMAL::INT4;
ERROR:  integer out of range
-- Ensure underflow of int4 is detected
SELECT '-2147483649'::FIXEDDECIMAL::INT4;
ERROR:  integer out of range
-- Ensure overflow is detected
SELECT SUM(a) FROM (VALUES('92233720368547758.07'::FIXEDDECIMAL),('0.01'::FIXEDDECIMAL)) a(a);
         sum          
----------------------
 92233720368547758.08
(1 row)

-- Ensure underflow is detected
SELECT SUM(a) FROM (VALUES('-92233720368547758.08'::FIXEDDECIMAL),('-0.01'::FIXEDDECIMAL)) a(a);
          sum           
------------------------
 -92233720368547758.090
(1 row)

-- Test typmods
SELECT 12345.33::FIXEDDECIMAL(3,2); -- Fail
ERROR:  FIXEDDECIMAL field overflow
DETAIL:  A field with precision 5, scale 2 must round to an absolute value less than 10^1.
SELECT 12345.33::FIXEDDECIMAL(5,2); -- Fail
ERROR:  FIXEDDECIMAL field overflow
DETAIL:  A field with precision 5, scale 2 must round to an absolute value less than 10^3.
-- scale of 2 should be enforced.
SELECT 12345.44::FIXEDDECIMAL(7,0);
 fixeddecimal 
--------------
 12345
(1 row)

-- should work.
SELECT 12345.33::FIXEDDECIMAL(7,2);
 fixeddecimal 
--------------
 12345.33
(1 row)

-- error, precision limit should be 17
SELECT 12345.33::FIXEDDECIMAL(18,2);
 fixeddecimal 
--------------
 12345.33
(1 row)

CREATE TABLE fixdec (d FIXEDDECIMAL(3,2));
INSERT INTO fixdec VALUES(12.34); -- Fail
ERROR:  FIXEDDECIMAL field overflow
DETAIL:  A field with precision 2, scale 2 must round to an absolute value less than 10^1.
INSERT INTO fixdec VALUES(1.23); -- Pass
DROP TABLE fixdec;
